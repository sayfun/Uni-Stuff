<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Curious Case of the Vanishing Engagement</title>
  <!-- Retro Font for that Monkey Island vibe -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0b1020;
      --bg-alt: #151a2b;
      --card-bg: #1e2538;
      --accent: #ffb347; /* Amber/Gold for pirate vibe */
      --accent-soft: rgba(255, 179, 71, 0.2);
      --text-main: #f5f5f7;
      --text-muted: #a4a9c0;
      --danger: #ff5c5c;
      --success: #7ddc8a;
      --radius: 8px;
      --retro-font: "VT323", monospace;
      --main-font: "Inter", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--main-font);
      background-color: var(--bg);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(30, 37, 56, 0.5) 0%, transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(30, 37, 56, 0.5) 0%, transparent 25%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 24px;
      min-height: 100vh;
    }

    /* CRT Scanline Effect */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
      background-size: 100% 4px;
      z-index: 999;
      pointer-events: none;
    }

    .app {
      max-width: 980px;
      width: 100%;
      background: linear-gradient(145deg, #0d1221, #090b16);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      padding: 24px 24px 30px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    /* Header Styles */
    header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      padding-bottom: 16px;
      margin-bottom: 20px;
    }

    .subtitle {
      font-family: var(--retro-font);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 18px;
      color: var(--accent);
      margin-bottom: 4px;
      text-shadow: 0 0 5px rgba(255, 179, 71, 0.3);
    }

    h1 {
      margin: 0;
      font-family: var(--retro-font);
      font-size: 32px;
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
    }

    h1 span.icon {
      font-size: 32px;
    }

    .chapter-tag {
      font-family: var(--retro-font);
      font-size: 18px;
      padding: 4px 12px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-muted);
      background: rgba(0,0,0,0.2);
    }

    .progress-bar {
      margin-top: 12px;
      height: 6px;
      width: 100%;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #ff8c42);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255, 179, 71, 0.5);
    }

    /* Common Components */
    .intro-card {
      background: rgba(15, 20, 35, 0.95);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--accent);
      margin-bottom: 24px;
      font-size: 15px;
      color: var(--text-muted);
      line-height: 1.6;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .intro-title {
      font-family: var(--retro-font);
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text-main);
      letter-spacing: 0.05em;
    }

    .section-title {
      font-family: var(--retro-font);
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin: 24px 0 14px;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      padding-bottom: 4px;
      display: inline-block;
    }

    .chapter-screen {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .chapter-screen.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-6px); }
        100% { transform: translateY(0px); }
    }
    
    @keyframes bob {
        0% { transform: translateY(0px) rotate(0deg); }
        25% { transform: translateY(-4px) rotate(3deg); }
        50% { transform: translateY(0px) rotate(0deg); }
        75% { transform: translateY(-4px) rotate(-3deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }

    .bob-icon {
        display: inline-block;
        animation: bob 4s ease-in-out infinite;
    }

    /* Start Screen specific styles */
    .start-hero {
        text-align: center;
        padding: 60px 20px;
    }
    .start-icon {
        font-size: 80px;
        margin-bottom: 24px;
        display: block;
        text-shadow: 0 0 30px rgba(255, 179, 71, 0.3);
    }
    .start-title {
        font-family: var(--retro-font);
        font-size: 42px;
        color: var(--text-main);
        margin-bottom: 20px;
        line-height: 1.1;
        text-shadow: 2px 2px 0px #000;
    }
    .start-desc {
        font-size: 16px;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto 40px;
        line-height: 1.6;
    }
    
    .name-input-container {
        max-width: 300px;
        margin: 0 auto 24px;
    }
    
    .name-input {
        width: 100%;
        background: rgba(0,0,0,0.3);
        border: 2px solid var(--accent);
        color: var(--text-main);
        font-family: var(--retro-font);
        font-size: 20px;
        padding: 12px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 16px;
        outline: none;
        transition: box-shadow 0.3s;
    }
    
    .name-input:focus {
        box-shadow: 0 0 15px var(--accent-soft);
    }

    .btn-start {
        background: var(--accent);
        color: #211000;
        font-family: var(--retro-font);
        font-size: 24px;
        padding: 12px 40px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s, filter 0.1s;
        box-shadow: 0 4px 0 #c48b36; /* Retro 3D button look */
    }
    .btn-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #c48b36;
        filter: brightness(1.1);
    }
    .btn-start:active {
        transform: translateY(2px);
        box-shadow: 0 0 0 #c48b36;
    }

    /* Cards & Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      border-color: rgba(255, 179, 71, 0.5);
    }

    .metric-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent), 0 14px 30px rgba(0, 0, 0, 0.7);
      background: linear-gradient(145deg, rgba(255, 179, 71, 0.1), rgba(30, 37, 56, 0.9));
    }

    .metric-id {
      font-family: var(--retro-font);
      font-size: 16px;
      color: var(--accent);
      letter-spacing: 0.05em;
    }

    .metric-text {
      font-size: 14px;
      line-height: 1.45;
      color: var(--text-main);
    }

    .metric-radio {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .metric-radio-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: transparent;
      transition: background 0.2s;
    }

    .metric-card.selected .metric-radio {
      border-color: var(--accent);
    }

    .metric-card.selected .metric-radio-dot {
      background: var(--accent);
    }

    /* Tasks & Forms */
    .task-box {
      background: var(--bg-alt);
      border-radius: var(--radius);
      padding: 16px 20px;
      border-left: 4px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .task-title {
      font-family: var(--retro-font);
      font-size: 18px;
      margin-bottom: 8px;
      color: #fff;
      letter-spacing: 0.05em;
    }

    .task-text {
      color: var(--text-muted);
      line-height: 1.5;
      font-size: 14px;
    }
    
    .task-box ul {
        margin: 8px 0 0 20px;
        padding-left: 0;
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .task-box ul li {
        margin-bottom: 4px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      font-family: var(--retro-font);
      font-size: 18px;
      display: block;
      margin-bottom: 6px;
      color: var(--text-main);
      letter-spacing: 0.03em;
    }
    
    .mini-label {
      font-family: var(--retro-font);
      font-size: 16px;
      color: var(--text-muted);
      margin-top: 4px;
      margin-bottom: 6px;
    }

    textarea,
    select,
    input[type="text"].std-input {
      width: 100%;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: #050714;
      color: var(--text-main);
      padding: 12px;
      font-family: var(--main-font);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.5;
    }

    textarea:focus,
    select:focus,
    input[type="text"].std-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 179, 71, 0.3);
    }

    select {
      height: 42px;
      cursor: pointer;
    }

    .helper-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    /* Buttons */
    .btn-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    button.btn-primary {
      background: var(--accent);
      color: #211000;
      font-family: var(--retro-font);
      font-weight: 400;
      font-size: 20px;
      padding: 10px 24px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 0 #c48b36;
      transition: transform 0.1s;
    }

    button.btn-primary:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }
    
    button.btn-primary:active {
      transform: translateY(2px);
      box-shadow: 0 0 0 #c48b36;
    }
    
    button.btn-secondary {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.3);
        color: var(--text-muted);
        font-family: var(--retro-font);
        font-size: 20px;
        padding: 10px 24px;
        border-radius: 4px;
        cursor: pointer;
    }
    button.btn-secondary:hover {
        border-color: var(--text-main);
        color: var(--text-main);
    }

    /* Status Messages */
    .status {
      font-family: var(--retro-font);
      font-size: 16px;
      margin-top: 12px;
      min-height: 20px;
    }

    .status.error {
      color: var(--danger);
      animation: shake 0.4s linear;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .status.success {
      color: var(--success);
    }

    /* Summary Box */
    .summary-box {
      margin-top: 30px;
      padding: 30px;
      border-radius: 12px;
      background: rgba(16, 185, 129, 0.05);
      border: 2px dashed rgba(16, 185, 129, 0.3);
      position: relative;
    }

    .tada-container {
        text-align: center;
        margin-bottom: 20px;
    }
    .tada-icon {
        font-size: 60px;
        display: inline-block;
        animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes pop {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }
    .summary-title {
      font-family: var(--retro-font);
      font-size: 24px;
      color: var(--success);
      margin-top: 10px;
    }
    
    .final-instruction {
        text-align: center;
        color: #a8e6cf;
        font-size: 15px;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .final-output {
      width: 100%;
      min-height: 200px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: #050714;
      color: #a8e6cf;
      font-family: monospace;
      padding: 16px;
      font-size: 13px;
      resize: vertical;
      white-space: pre-wrap;
      margin-bottom: 20px;
    }
    
    .chapter-nav {
        display: flex;
        justify-content: center;
    }

    /* Character Cards */
    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .character-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 14px;
    }

    .character-name {
      font-family: var(--retro-font);
      font-size: 20px;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .character-role {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .character-quote {
      font-style: italic;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .character-card .helper-text {
        margin-top: 8px;
        opacity: 0.7;
    }

    /* Chart List */
    .chart-list {
      background: var(--bg-alt);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 14px;
      color: var(--text-main);
      margin-bottom: 16px;
    }

    .chart-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .chart-item:last-child {
        border-bottom: none;
    }

    .chart-label {
      font-weight: 600;
      color: var(--accent);
    }

    /* Final boss shock overlay */
    .twist-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #2b0d0d 0, #050005 55%);
      z-index: 9999;
    }
    .twist-card {
      max-width: 640px;
      width: 92%;
      background: #120308;
      border-radius: 16px;
      border: 1px solid rgba(255,80,80,0.6);
      box-shadow: 0 22px 70px rgba(0,0,0,0.85);
      padding: 30px;
      text-align: left;
      animation: shake 0.5s;
    }
    .twist-title {
      font-family: var(--retro-font);
      font-size: 28px;
      font-weight: 700;
      color: #ff7070;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .twist-warning {
      font-size: 15px;
      color: #ffb3b3;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .twist-small {
      font-size: 13px;
      color: #f5f5f7;
      margin-bottom: 20px;
      line-height: 1.5;
      opacity: 0.8;
    }
    .twist-label {
      font-family: var(--retro-font);
      font-size: 18px;
      color: #ffd1d1;
      margin-bottom: 8px;
    }
    .twist-textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(255,180,180,0.4);
      background: #1b0509;
      color: #f5f5f7;
      padding: 12px;
      font-size: 14px;
      min-height: 120px;
      resize: vertical;
      font-family: var(--main-font);
      outline: none;
    }
    .twist-textarea:focus {
        border-color: #ff7070;
        box-shadow: 0 0 10px rgba(255, 112, 112, 0.2);
    }
    .twist-error {
      font-family: var(--retro-font);
      font-size: 16px;
      color: #ff9b9b;
      margin-top: 8px;
      display: none;
    }
    .twist-note {
      font-size: 12px;
      color: #c9c9ff;
      margin-top: 12px;
      font-style: italic;
    }

    /* Fun Layer UI */
    #fun-status-bar {
      margin-top: 16px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(5, 7, 20, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #cfd2ea;
    }

    #fun-emoji {
      font-size: 16px;
    }

    .fun-buttons-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .fun-btn {
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: transparent;
      color: #f5f5f7;
      font-size: 12px;
      cursor: pointer;
    }

    .fun-btn:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .fun-btn-ghost {
      border-style: dashed;
      opacity: 0.9;
    }

    /* Council popup */
    #council-popup {
      position: fixed;
      right: 16px;
      bottom: 24px;
      max-width: 260px;
      font-size: 12px;
      color: #fefefe;
      background: rgba(9, 11, 28, 0.96);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 8px 10px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 900;
    }

    #council-popup.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Chapter badge */
    #chapter-badge {
      margin-top: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,200,90,0.4);
      background: radial-gradient(circle at left, rgba(255,200,90,0.3), rgba(8,9,24,0.95));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #ffe9b3;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    #chapter-badge.unlocked {
      opacity: 1;
      transform: translateY(0);
    }

    .badge-icon {
      font-size: 14px;
    }

    .badge-text {
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #11182f 0, #020309 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }

    .loading-card {
      max-width: 320px;
      width: 80%;
      background: #060816;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 18px 60px rgba(0,0,0,0.9);
      padding: 18px 20px 16px;
      text-align: left;
    }

    .loading-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .loading-sub {
      font-size: 12px;
      color: #cfd2ea;
      margin-bottom: 10px;
    }

    .loading-spinner {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: #ffb347;
      margin: 0 auto 8px;
      animation: spin 0.9s linear infinite;
    }

    .loading-tip {
      font-size: 11px;
      color: #9aa0d0;
      margin-top: 2px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Level-up toast */
    #levelup-toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(12px);
      background: radial-gradient(circle at left, rgba(255,210,110,0.25), rgba(10,10,25,0.98));
      border-radius: 999px;
      border: 1px solid rgba(255,210,110,0.5);
      padding: 6px 12px 6px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #fff5d2;
      opacity: 0;
      pointer-events: none;
      box-shadow: 0 16px 45px rgba(0,0,0,0.75);
      z-index: 1100;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    #levelup-toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .levelup-icon {
      font-size: 16px;
    }

    .levelup-title {
      font-weight: 600;
    }

    .levelup-sub {
      font-size: 10px;
    }

    /* Dialog overlay */
    #dialog-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.7), rgba(0,0,0,0.94));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1300;
    }

    #dialog-overlay.visible {
      display: flex;
    }

    .dialog-card {
      max-width: 540px;
      width: 90%;
      background: #050714;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 22px 70px rgba(0,0,0,0.9);
      padding: 14px 16px 12px;
      font-size: 13px;
      color: #f5f5f7;
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    #dialog-character {
      font-weight: 600;
      font-size: 13px;
      color: #ffb347;
    }

    #dialog-close-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.33);
      background: transparent;
      color: #f5f5f7;
      font-size: 11px;
      padding: 2px 7px;
      cursor: pointer;
    }

    #dialog-text {
      font-size: 12px;
      color: #dde0ff;
      min-height: 46px;
      line-height: 1.5;
    }

    .dialog-footer {
      margin-top: 10px;
      text-align: right;
    }

    #dialog-next-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 14px;
      background: #ffb347;
      color: #221000;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 640px) {
      .app {
        padding: 16px 16px 24px;
      }
      h1 { font-size: 24px; }
      .start-title { font-size: 32px; }
    }
  </style>
</head>
<body>
  <div class="app" id="main-app">
    <header>
      <div class="subtitle" id="headerSubtitle">Analytics Adventure</div>
      <div class="top-row">
        <h1>
          <span class="icon bob-icon">üß≠</span>
          <span>The Curious Case of the Vanishing Engagement</span>
        </h1>
        <div class="chapter-tag" id="chapterTag">Briefing</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </header>

    <!-- START SCREEN (Chapter 0) -->
    <section id="chapter-0" class="chapter-screen active">
        <div class="start-hero">
            <span class="start-icon bob-icon">üïµÔ∏è‚Äç‚ôÄÔ∏è</span>
            <div class="start-title">The Case of the Vanishing Engagement</div>
            <p class="start-desc">
                Engagement metrics at MUIC have dropped to zero. The logs are corrupted. The stakeholders are panicking.<br><br>
                Analyze the data, navigate the politics, and design a plan to save the semester.
            </p>
            
            <div class="name-input-container">
                <input type="text" id="investigatorName" class="name-input" placeholder="Enter Your Name" autocomplete="off">
            </div>
            
            <button class="btn-start" id="btnStartGame">Begin Investigation ‚û°Ô∏è</button>
            <div class="status" id="startStatus"></div>
        </div>
    </section>

    <!-- CHAPTER 1 -->
    <section id="chapter-1" class="chapter-screen">
      <div class="intro-card">
        <div class="intro-title">Chapter 1 ¬∑ The Island of Misleading Metrics <span class="bob-icon">üèùÔ∏è</span></div>
        <p id="ch1IntroText">
          Your analytics ship crashes on the shores of Analytics Island. The sand is
          warm, the Wi-Fi is questionable, and the only things that washed up with you
          are six data fragments.
        </p>
        <p style="margin-top:6px;">
           Some are useful. Some are misleading. Some actively want to trick you.
           To leave the beach, you must choose <strong>one</strong> metric worth
           carrying forward as your anchor insight.
        </p>
      </div>

      <div class="section-title">Data fragments on the beach <span class="bob-icon">üêö</span></div>
      <div class="metrics-grid" id="metricsGrid"></div>

      <div class="task-box">
        <div class="task-title">Step 1 ‚Äì Your choice (Anchor Metric)</div>
        <div class="task-text">
           Review all six fragments and choose <strong>ONE</strong> anchor metric.
        </div>
        <ul>
           <li>Which fragment tells you something meaningful about <strong>quality</strong> or <strong>behavior</strong>?</li>
           <li>Which one is more than just a ‚Äúnumbers look big‚Äù moment?</li>
           <li>Which one would you actually show in a serious MUIC meeting?</li>
        </ul>
      </div>

      <div class="form-group">
        <label for="ch1Justification">Why did you choose this as your anchor metric?</label>
        <textarea id="ch1Justification" class="std-input"
          placeholder="Explain in 3‚Äì5 sentences why this is your main metric and what story it suggests..."></textarea>
      </div>

      <div class="task-box">
         <div class="task-title">Step 2 ‚Äì Solo Quest: Defense & Counter-Arguments</div>
         <div class="task-text">
            Solo quest extension: After choosing your anchor metric, write:
         </div>
         <ul>
            <li>One short <strong>defense</strong> of why your choice is the strongest signal.</li>
            <li>Two short <strong>counter-arguments</strong> explaining why two other fragments would be misleading or weaker choices.</li>
         </ul>
         <div class="task-text" style="margin-top:8px; font-style:italic; font-size:12px;">
            Imagine you are arguing against confused stakeholders who love vanity metrics, not against other student teams.
         </div>
      </div>

      <div class="form-group">
        <label>Defense ‚Äì why your anchor wins</label>
        <textarea id="ch1Defense" class="std-input" placeholder="Defend your anchor metric as the best lens..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Counter-arguments against other metrics</label>
        <textarea id="ch1Rebuttal" class="std-input" placeholder="Explain why two alternative anchor metrics would be less useful or misleading..."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Instructor Checkpoint</div>
        <div class="task-text">
           Before moving to Chapter 2, make sure you are prepared to explain your choice in 30‚Äì60 seconds during a later class discussion.
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="ch1Submit">‚úÖ Submit Chapter 1</button>
      </div>
      <div class="status" id="ch1Status"></div>
    </section>

    <!-- CHAPTER 2 -->
    <section id="chapter-2" class="chapter-screen">
      <div class="intro-card">
        <div class="intro-title">Chapter 2 ¬∑ The Council of Conflicting Stakeholders <span class="bob-icon">üèõÔ∏è</span></div>
        <p>
          You climb the hill and meet three powerful voices arguing about what your anchor metric ‚Äúreally‚Äù means.
          Your job is to decide who helps you tell a useful story, not just who is the loudest.
        </p>
        <p style="margin-top:6px;">Start by reminding yourself what you picked in Chapter 1.</p>
      </div>

      <div class="section-title">Stakeholders on the hill <span class="bob-icon">‚õ∞Ô∏è</span></div>
      <div class="character-grid">
        <div class="character-card">
          <div class="character-name">Dean of Panic</div>
          <div class="character-role">‚ÄúWe are losing reputation.‚Äù</div>
          <div class="character-quote">
            ‚ÄúEngagement is down? This is catastrophic. Fix it immediately. I don‚Äôt want
            excuses; I want a strong, simple answer.‚Äù
          </div>
          <div class="helper-text">
            Cares about: optics, simple answers, short-term risk.
          </div>
        </div>
        <div class="character-card">
          <div class="character-name">Marketing Pirate</div>
          <div class="character-role">‚ÄúThe numbers look fine.‚Äù</div>
          <div class="character-quote">
            ‚ÄúReach is up, followers are up, everything looks great. Students are just
            busy with exams. We don‚Äôt need to change anything.‚Äù
          </div>
          <div class="helper-text">
            Cares about: defending current work, vanity metrics.
          </div>
        </div>
        <div class="character-card">
          <div class="character-name">Student Ghost</div>
          <div class="character-role">‚ÄúIt‚Äôs not for us.‚Äù</div>
          <div class="character-quote">
            ‚ÄúI see your posts but I don‚Äôt really care. They feel generic and not really
            about student life.‚Äù
          </div>
          <div class="helper-text">
            Cares about: relevance, tone, authenticity.
          </div>
        </div>
      </div>

      <div class="task-box">
        <div class="task-title">Step 1 ‚Äì Classify the voices</div>
        <div class="task-text">
          On your own, classify each role:
        </div>
      </div>

      <div class="form-group">
        <label>Most analytically useful perspective</label>
        <select id="ch2Useful" class="std-input">
          <option value="">Select one‚Ä¶</option>
          <option value="dean">Dean of Panic</option>
          <option value="marketing">Marketing Pirate</option>
          <option value="student">Student Ghost</option>
        </select>
      </div>

      <div class="form-group">
        <label>Most emotion-driven perspective</label>
        <select id="ch2Emotional" class="std-input">
          <option value="">Select one‚Ä¶</option>
          <option value="dean">Dean of Panic</option>
          <option value="marketing">Marketing Pirate</option>
          <option value="student">Student Ghost</option>
        </select>
      </div>

      <div class="form-group">
        <label>Most misleading perspective</label>
        <select id="ch2Misleading" class="std-input">
          <option value="">Select one‚Ä¶</option>
          <option value="dean">Dean of Panic</option>
          <option value="marketing">Marketing Pirate</option>
          <option value="student">Student Ghost</option>
        </select>
      </div>

      <div class="task-box">
        <div class="task-title">Step 2 ‚Äì Build your Sparkline</div>
        <div class="task-text">
          You must turn your Chapter 1 anchor metric into a story using a simple Duarte-style arc:
        </div>
      </div>

      <div class="form-group">
        <label>‚ÄúWhat is‚Äù ‚Äì current state</label>
        <textarea id="ch2WhatIs" class="std-input"
          placeholder="Describe the current reality as your data suggests it."></textarea>
      </div>

      <div class="form-group">
        <label>Conflict / tension</label>
        <textarea id="ch2Conflict" class="std-input"
          placeholder="What‚Äôs the main problem, mismatch, or risk?"></textarea>
      </div>

      <div class="form-group">
        <label>Insight ‚Äì turning point</label>
        <textarea id="ch2Insight" class="std-input"
          placeholder="What key insight changes how we understand the situation?"></textarea>
      </div>

      <div class="form-group">
        <label>‚ÄúWhat could be‚Äù ‚Äì improved future</label>
        <textarea id="ch2CouldBe" class="std-input"
          placeholder="What realistic, improved future becomes possible?"></textarea>
      </div>
      
      <div class="task-box">
          <div class="task-title">Step 3 ‚Äì Solo quest extension: Perspective rewrites</div>
          <div class="task-text">Rewrite your <strong>insight</strong> from three different perspectives:</div>
          <ul>
              <li>Reflect on how your own understanding changes when you switch voices.</li>
          </ul>
      </div>
      
      <div class="form-group">
          <label>Insight from the Dean‚Äôs perspective</label>
          <textarea id="ch2InsightDean" class="std-input" placeholder="Short, strong, risk-focused."></textarea>
      </div>
      <div class="form-group">
          <label>Insight from the Marketing Pirate‚Äôs perspective</label>
          <textarea id="ch2InsightPirate" class="std-input" placeholder="Defensive spin on the strategy."></textarea>
      </div>
      <div class="form-group">
          <label>Insight from the Student Ghost‚Äôs perspective</label>
          <textarea id="ch2InsightStudent" class="std-input" placeholder="Bored, annoyed, or unimpressed."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Instructor Checkpoint</div>
        <div class="task-text">
           Be ready to explain your stakeholder choice, story arc, and one rewritten perspective in a later class discussion.
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="ch2Submit">‚úÖ Submit Chapter 2</button>
      </div>
      <div class="status" id="ch2Status"></div>
    </section>

    <!-- CHAPTER 3 -->
    <section id="chapter-3" class="chapter-screen">
      <div class="intro-card">
        <div class="intro-title">Chapter 3 ¬∑ The Temple of Missing Context <span class="bob-icon">üóø</span></div>
        <p>
          Deeper inside the island, you find three impressive-looking charts carved into stone. 
          They would look great in a slide deck. They are also terrible.
        </p>
        <p style="margin-top:6px;">
          Your job is not to ‚Äúmake them pretty‚Äù. Your job is to stop them from lying.
        </p>
      </div>

      <div class="section-title">Ancient charts on the wall <span class="bob-icon">üìú</span></div>
      <div class="chart-list">
        <div class="chart-item">
          <span class="chart-label">Chart A:</span> Bar chart titled
          <em>‚ÄúEngagement by Month‚Äù</em>, but neither the Y-axis nor the timeframe
          labels are visible.
        </div>
        <div class="chart-item">
          <span class="chart-label">Chart B:</span> Line chart titled
          <em>‚ÄúPosts per Week vs Applications‚Äù</em>. The lines move in the same
          direction, but there is no indication of causality.
        </div>
        <div class="chart-item">
          <span class="chart-label">Chart C:</span> Pie chart titled
          <em>‚ÄúContent Types‚Äù</em> with slices that sum to 132%.
        </div>
      </div>

      <div class="task-box">
        <div class="task-title">Step 1 ‚Äì Choose your stone</div>
        <div class="task-text">
          On your own, choose <strong>one</strong> chart that is most dangerous or misleading.
        </div>
      </div>

      <div class="form-group">
        <label>Which chart did you pick?</label>
        <select id="ch3ChartChoice" class="std-input">
          <option value="">Select one‚Ä¶</option>
          <option value="A">Chart A ‚Äì Engagement by Month</option>
          <option value="B">Chart B ‚Äì Posts vs Applications</option>
          <option value="C">Chart C ‚Äì Content Types</option>
        </select>
      </div>

      <div class="form-group">
        <label>Step 2 ‚Äì What context is missing or unclear?</label>
        <textarea id="ch3Missing" class="std-input"
          placeholder="Describe exactly what information is missing: labels, timeframe, causality, definitions..."></textarea>
      </div>

      <div class="form-group">
        <label>Step 3 ‚Äì Rewrite: what should this chart honestly say?</label>
        <textarea id="ch3Rewrite" class="std-input"
          placeholder="Write a more honest interpretation, as if annotating for a stakeholder."></textarea>
      </div>
      
      <div class="task-box">
        <div class="task-title">Step 4 ‚Äì Solo quest extension: Honest vs. Evil Charts</div>
        <div class="task-text">
            1) Create an honest, corrected version of your chosen chart (fix labels, scales, titles, and context).<br>
            2) Then, create a deliberately manipulated 'evil' version (e.g., distorted axis, missing labels, exaggerated visuals).<br>
            3) Write 2‚Äì4 sentences below explaining exactly how your manipulated version could mislead a stakeholder.
        </div>
      </div>
      
      <div class="form-group">
          <label>Describe your honest and evil versions</label>
          <textarea id="ch3Mockup" class="std-input" placeholder="Describe the changes in your honest version, and then explain the tricks used in your 'evil' version."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Instructor Checkpoint</div>
        <div class="task-text">
           Be ready to show and explain both your honest and manipulated chart versions in a future class discussion.
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="ch3Submit">‚úÖ Submit Chapter 3</button>
      </div>
      <div class="status" id="ch3Status"></div>
    </section>

    <!-- CHAPTER 4 -->
    <section id="chapter-4" class="chapter-screen">
      <div class="intro-card">
        <div class="intro-title">Chapter 4 ¬∑ The Final Gate ‚Äì Action Engine <span class="bob-icon">üîÆ</span></div>
        <p>
          You reach the final gate. The guardian asks only one question:
          <br><br>
          <strong>‚ÄúSo what do you want someone at MUIC to actually do next week?‚Äù</strong>
        </p>
        <p>
          Use Fogg‚Äôs Behavior Model: <strong>Behavior = Motivation √ó Ability √ó Prompt</strong>.
        </p>
      </div>

      <div class="task-box">
        <div class="task-title">Step 1 ‚Äì Quick recap of your story</div>
        <div class="task-text" id="ch4AnchorPreview">
          <!-- Filled by JS -->
        </div>
      </div>
      
      <div class="form-group">
          <label>Story recap (anchor + insight + risk/opportunity)</label>
          <textarea id="ch4StoryRecap" class="std-input" placeholder="Write 2‚Äì3 sentences summarizing your findings so far..."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Step 2 ‚Äì Design your behavior (B=MAP)</div>
        <div class="task-text">
          Choose <strong>one concrete behavior</strong> you want a stakeholder to perform.
        </div>
      </div>

      <div class="form-group">
        <label>Motivation ‚Äì why would the stakeholder want to do this?</label>
        <textarea id="ch4Motivation" class="std-input"
          placeholder="What pain are you reducing, or what positive outcome are you creating?"></textarea>
      </div>

      <div class="form-group">
        <label>Ability ‚Äì how do you make the action easy?</label>
        <textarea id="ch4Ability" class="std-input"
          placeholder="Reduce friction: time, complexity, approvals, budget, steps."></textarea>
      </div>

      <div class="form-group">
        <label>Prompt ‚Äì what triggers the action at the right moment?</label>
        <textarea id="ch4Prompt" class="std-input"
          placeholder="Specify a moment + channel (e.g., weekly meeting, email report)."></textarea>
      </div>

      <div class="form-group">
        <label>Step 3 ‚Äì Final action statement</label>
        <textarea id="ch4Action" class="std-input"
          placeholder="Combine everything into one clear sentence."></textarea>
      </div>
      
      <div class="task-box">
          <div class="task-title">Step 4 ‚Äì Solo quest extension ‚Äì Self-review</div>
          <div class="task-text">Before finalizing your action, review your own recommendation using these questions:</div>
          <ul>
              <li>Would someone understand the behavior in 10 seconds?</li>
              <li>Is this action realistic within the next 30 days?</li>
              <li>Does the prompt happen at a specific, sensible moment?</li>
          </ul>
          <div class="task-text">Based on your answers, rewrite your action one more time below.</div>
      </div>
      
      <div class="form-group">
          <label>Your self-review notes</label>
          <textarea id="ch4Feedback" class="std-input" placeholder="Notes on clarity, realism, and prompt timing based on the questions above."></textarea>
      </div>
      
      <div class="form-group">
          <label>Step 5 ‚Äì Revised final action (after self-review)</label>
          <textarea id="ch4RevisedAction" class="std-input" placeholder="Rewrite your action statement to make it clearer and more realistic."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Instructor Checkpoint & Future Sharing</div>
        <div class="task-text">
           You may be asked to share your final action in a future make-up class or discussion group.
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="ch4Submit">‚úÖ Submit Chapter 4</button>
      </div>
      <div class="status" id="ch4Status"></div>
    </section>

    <!-- CHAPTER 5 -->
    <section id="chapter-5" class="chapter-screen">
      <div class="intro-card">
        <div class="intro-title">Chapter 5 ¬∑ Final Boss: MUIC Council Challenge <span class="bob-icon">üêâ</span></div>
        <p>
          You‚Äôve survived the island. Now you enter the MUIC council room.
          The final boss is simple and brutal: <strong>Can you turn all of this into one coherent, defendable story?</strong>
        </p>
      </div>

      <div class="task-box">
        <div class="task-title">Step 1 ‚Äì Insight-to-Action Blueprint <span class="bob-icon">üó∫Ô∏è</span></div>
        <div class="task-text">
          Combine everything from Chapters 1‚Äì4 into one compact blueprint. Imagine briefing a busy stakeholder in 3 minutes.
        </div>
      </div>

      <div class="form-group">
        <label>1. Anchor metric & trend (island case)</label>
        <textarea id="ch5AnchorRecap" class="std-input"
          placeholder="In 3‚Äì5 sentences, recap your chosen anchor metric and what the trend tells you about engagement."></textarea>
      </div>

      <div class="form-group">
        <label>2. Story arc (what is ‚Üí conflict ‚Üí insight ‚Üí what could be)</label>
        <textarea id="ch5StoryArcRecap" class="std-input"
          placeholder="In 6‚Äì8 sentences, tell the narrative backbone: current state, problem, insight, and better future."></textarea>
      </div>

      <div class="form-group">
        <label>3. Chart you would show (describe your honest vs evil work)</label>
        <textarea id="ch5ChartRecap" class="std-input"
          placeholder="Describe the chart type, why the scale/context is honest, and how it supports your insight."></textarea>
      </div>

      <div class="form-group">
        <label>4. Behavior you recommend (Fogg B=MAP)</label>
        <textarea id="ch5BehaviorRecap" class="std-input"
          placeholder="Summarize the concrete behavior, including who should do what, when, and why it's realistic."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Step 2 ‚Äì The council pushes back</div>
        <div class="task-text">
          Three familiar voices challenge you. Write your short, calm response to each.
        </div>
      </div>

      <div class="form-group">
        <div class="mini-label">Dean of Panic ‚Äì objection & your response</div>
        <textarea id="ch5DeanObjection" class="std-input"
          placeholder="Write 1‚Äì2 sentences for the Dean‚Äôs objection, and 2‚Äì3 sentences for your reply."></textarea>
      </div>

      <div class="form-group">
        <div class="mini-label">Marketing Pirate ‚Äì objection & your response</div>
        <textarea id="ch5PirateObjection" class="std-input"
          placeholder="Write 1‚Äì2 sentences where the Pirate defends status quo, and 2‚Äì3 sentences where you answer."></textarea>
      </div>

      <div class="form-group">
        <div class="mini-label">Student Ghost ‚Äì objection & your response</div>
        <textarea id="ch5StudentObjection" class="std-input"
          placeholder="Write 1‚Äì2 sentences where a student is still bored, and your adjustment/explanation."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Step 3 ‚Äì Connect the island to your real project</div>
        <div class="task-text">
          Switch from the fictional MUIC island case to your own final project topic.
        </div>
      </div>

      <div class="form-group">
        <label>Real project metric & early insight</label>
        <textarea id="ch5RealMetric" class="std-input"
          placeholder="Name one metric from your project and write 3‚Äì5 sentences about what it might reveal."></textarea>
      </div>

      <div class="form-group">
        <label>Draft story + action for your real project</label>
        <textarea id="ch5RealDraft" class="std-input"
          placeholder="In 6‚Äì8 sentences, sketch a possible story arc and one behavior you might recommend later."></textarea>
      </div>

      <div class="task-box">
        <div class="task-title">Step 4 ‚Äì Self-check</div>
        <div class="task-text">
          Quickly self-review your work. Is it clear to a non-analytics person?
        </div>
      </div>

      <div class="form-group">
        <label>Short reflection</label>
        <textarea id="ch5Reflection" class="std-input"
          placeholder="In 5‚Äì7 sentences, reflect on what you learned about turning data into a story with a clear action."></textarea>
      </div>

      <!-- Fun Layer UI -->
      <div id="fun-status-bar">
        <span id="fun-emoji">üòê</span>
        <span id="fun-status-text">Type to wake the council...</span>
      </div>

      <div class="fun-buttons-row">
        <button type="button" class="fun-btn" onclick="triggerConfused()">I feel confused</button>
        <button type="button" class="fun-btn fun-btn-ghost" onclick="triggerDrama()">Give me more drama</button>
      </div>

      <div id="chapter-badge">
        <span class="badge-icon">üèÖ</span>
        <span class="badge-text">Chapter progress badge unlocked</span>
      </div>

      <div id="council-popup"></div>

      <div class="btn-row">
        <button class="btn-primary" onclick="triggerFinalBoss()">Finish Quest</button>
        <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
      </div>

      <div class="status" id="ch5Status"></div>

      <div class="summary-box" id="ch5Summary" style="display:none;">
        <div class="tada-container">
            <div class="tada-icon"><span class="bob-icon">üéâ</span></div>
            <div class="summary-title" style="font-size: 20px; color: #7ddc8a;">Mission Accomplished!</div>
        </div>
        <p class="final-instruction">
            Great job, Investigator <strong id="finalNameDisplay"></strong>. Your analysis is complete.<br>
            Please copy the report below and paste it into the <strong>Google Classroom</strong> assignment.
        </p>
        <textarea class="final-output" id="finalOutput" readonly></textarea>
        <div class="chapter-nav" style="justify-content: center;">
          <button class="btn-next" id="copyOutput" style="background: #7ddc8a; color: #092014; border: none; font-weight: 700; font-family: var(--retro-font); font-size: 20px; padding: 12px 30px;">
            Copy Report to Clipboard üìã
          </button>
        </div>
      </div>
    </section>

  </div>

  <!-- Final boss shock overlay -->
  <div class="twist-overlay" id="twist-overlay">
    <div class="twist-card">
      <div class="twist-title">‚ö†Ô∏è SYSTEM FAILURE: ISLAND MEMORY WIPE</div>
      <p class="twist-warning">
        Analytics Island just glitched. All visible answers on this page have been wiped from
        the interface.
      </p>
      <p class="twist-small">
        The good news: a hidden backup of your work still exists deep in the system.  
        The bad news: the gatekeeper will only release it if you complete one final task.
      </p>
      <p class="twist-label">
        Final task ‚Äì Meta reflection (minimum ~200 characters):
      </p>
      <textarea id="finalTaskAnswer" class="twist-textarea"
        placeholder="Explain, in detail, what you think is the single most important principle for turning data into a persuasive story that leads to action at MUIC. Connect it to at least one concept from the earlier chapters (anchor metrics, stakeholders, honest charts, or Fogg B=MAP)."></textarea>
      <div id="twist-error" class="twist-error">
        Your answer is too short to unlock the backup. Add more detail, examples, or explanation.
      </div>
      <p class="twist-note">
        When you complete this task, the system will restore your answers and generate a combined
        export block you can copy into your assignment.
      </p>
      <div class="btn-row">
        <button class="btn-primary" onclick="restoreFromFinalBoss()">Unlock &amp; Restore My Work</button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" style="display: none;">
    <div class="loading-card">
      <div class="loading-title">Connecting to Analytics Island...</div>
      <div class="loading-sub">Syncing council memories, metrics, and drama.</div>
      <div class="loading-spinner"></div>
      <div class="loading-tip">Tip: your answers are only stored in this tab. Don‚Äôt trust the island.</div>
    </div>
  </div>

  <!-- Level-up toast -->
  <div id="levelup-toast">
    <div class="levelup-icon">‚ú®</div>
    <div class="levelup-text">
      <div class="levelup-title">Level Up!</div>
      <div class="levelup-sub">You‚Äôve unlocked deeper narrative thinking for this chapter.</div>
    </div>
  </div>

  <!-- Monkey Island‚Äìstyle dialog overlay -->
  <div id="dialog-overlay">
    <div class="dialog-card">
      <div class="dialog-header">
        <span id="dialog-character">Council Member</span>
        <button type="button" id="dialog-close-btn">‚úï</button>
      </div>
      <div id="dialog-text"></div>
      <div class="dialog-footer">
        <button type="button" id="dialog-next-btn">Next line</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentChapter = 0;
    const totalChapters = 5;

    const state = {
      investigatorName: "",
      // CH1
      anchorMetricId: null,
      anchorMetricText: "",
      anchorJustification: "",
      anchorDefense: "",
      anchorRebuttal: "",
      // CH2
      ch2Useful: "",
      ch2Emotional: "",
      ch2Misleading: "",
      storyWhatIs: "",
      storyConflict: "",
      storyInsight: "",
      storyCouldBe: "",
      insightDean: "",
      insightPirate: "",
      insightStudent: "",
      // CH3
      ch3ChartChoice: "",
      ch3Missing: "",
      ch3Rewrite: "",
      ch3Mockup: "",
      // CH4
      storyRecap: "",
      actionMotivation: "",
      actionAbility: "",
      actionPrompt: "",
      actionStatement: "",
      feedbackReceived: "",
      revisedAction: "",
      // CH5
      ch5AnchorRecap: "",
      ch5StoryArcRecap: "",
      ch5ChartRecap: "",
      ch5BehaviorRecap: "",
      ch5DeanObjection: "",
      ch5PirateObjection: "",
      ch5StudentObjection: "",
      ch5RealMetric: "",
      ch5RealDraft: "",
      ch5Reflection: ""
    };

    const chapterTag = document.getElementById("chapterTag");
    const progressFill = document.getElementById("progressFill");
    const headerSubtitle = document.getElementById("headerSubtitle");

    function updateChapterUI() {
      document.querySelectorAll(".chapter-screen").forEach((ch) => {
        ch.classList.remove("active");
      });
      const active = document.getElementById(`chapter-${currentChapter}`);
      if (active) active.classList.add("active");

      if (currentChapter === 0) {
          chapterTag.textContent = "Briefing";
          progressFill.style.width = "0%";
      } else {
          chapterTag.textContent = `Chapter ${currentChapter} of ${totalChapters}`;
          const pct = (currentChapter - 1) / (totalChapters - 1 || 1) * 100;
          progressFill.style.width = `${pct}%`;
      }
      // Scroll to top on chapter change
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToChapter(n) {
      currentChapter = n;
      updateChapterUI();
    }
    
    // Start Screen Logic
    const btnStartGame = document.getElementById("btnStartGame");
    const nameInput = document.getElementById("investigatorName");
    const startStatus = document.getElementById("startStatus");

    btnStartGame.addEventListener("click", () => {
        const name = nameInput.value.trim();
        if (name.length < 2) {
            startStatus.textContent = "Please enter your name, Investigator.";
            startStatus.className = "status error";
            return;
        }
        state.investigatorName = name;
        
        // Personalize
        headerSubtitle.textContent = `Investigator: ${name}`;
        document.getElementById("ch1IntroText").innerHTML = `
          Welcome, <strong>Investigator ${name}</strong>. Your analytics ship crashes on the shores of Analytics Island. 
          The sand is warm, the Wi-Fi is questionable, and the only things that washed up with you are six data fragments.
        `;
        
        // Show loading overlay
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.style.display = "flex";
        setTimeout(() => {
            loadingOverlay.style.display = "none";
            goToChapter(1);
        }, 2000);
    });

    // CHAPTER 1 ‚Äì metrics setup (HARD MODE: NO LABELS/HINTS)
    const metrics = [
      { id: "Fragment A", text: "‚ÄúTotal Reach: Up +51% last month.‚Äù" },
      { id: "Fragment B", text: "‚ÄúEngagement Rate (organic posts only): Down from 4.3% ‚Üí 2.8%.‚Äù" },
      { id: "Fragment C", text: "Line chart with dramatic spikes, but Y-axis runs from 98% to 100%." },
      { id: "Fragment D", text: "‚ÄúComment sentiment: Neutral ‚Üí Slightly Negative over 6 weeks.‚Äù" },
      { id: "Fragment E", text: "Randomly highlighted KPI: ‚ÄúProfile Visits: +6000%‚Äù." },
      { id: "Fragment F", text: "‚ÄúAverage watch time on video content: Down 18%.‚Äù" },
    ];

    const metricsGrid = document.getElementById("metricsGrid");
    const ch1Justification = document.getElementById("ch1Justification");
    const ch1Defense = document.getElementById("ch1Defense");
    const ch1Rebuttal = document.getElementById("ch1Rebuttal");
    const ch1Submit = document.getElementById("ch1Submit");
    const ch1Status = document.getElementById("ch1Status");
    let selectedMetricId = null;

    function renderMetrics() {
      metricsGrid.innerHTML = "";
      metrics.forEach((metric) => {
        const card = document.createElement("div");
        card.className = "metric-card";
        card.dataset.id = metric.id;
        card.innerHTML = `
          <div class="metric-id">${metric.id}</div>
          <div class="metric-text">${metric.text}</div>
          <div class="metric-radio"><div class="metric-radio-dot"></div></div>
        `;
        card.addEventListener("click", () => selectMetric(metric.id));
        metricsGrid.appendChild(card);
      });
    }

    function selectMetric(id) {
      selectedMetricId = id;
      document.querySelectorAll(".metric-card").forEach((card) => {
        card.classList.toggle("selected", card.dataset.id === id);
      });
      ch1Status.textContent = "";
      ch1Status.className = "status";
    }

    function submitCh1() {
      const just = ch1Justification.value.trim();
      const def = ch1Defense.value.trim();
      const reb = ch1Rebuttal.value.trim();

      if (!selectedMetricId) {
        ch1Status.textContent = "Select one metric before submitting.";
        ch1Status.className = "status error";
        return;
      }
      if (just.length < 10 || def.length < 10 || reb.length < 10) {
        ch1Status.textContent = "Please complete the Justification, Defense, and Counter-arguments fields.";
        ch1Status.className = "status error";
        return;
      }
      
      const metric = metrics.find((m) => m.id === selectedMetricId);
      state.anchorMetricId = metric.id;
      state.anchorMetricText = metric.text;
      state.anchorJustification = just;
      state.anchorDefense = def;
      state.anchorRebuttal = reb;

      ch1Status.textContent = "Chapter 1 submitted. Unlocking Chapter 2...";
      ch1Status.className = "status success";
      setTimeout(() => goToChapter(2), 1000);
    }

    ch1Submit.addEventListener("click", submitCh1);

    // CHAPTER 2 logic
    const ch2Useful = document.getElementById("ch2Useful");
    const ch2Emotional = document.getElementById("ch2Emotional");
    const ch2Misleading = document.getElementById("ch2Misleading");
    const ch2WhatIs = document.getElementById("ch2WhatIs");
    const ch2Conflict = document.getElementById("ch2Conflict");
    const ch2Insight = document.getElementById("ch2Insight");
    const ch2CouldBe = document.getElementById("ch2CouldBe");
    const ch2InsightDean = document.getElementById("ch2InsightDean");
    const ch2InsightPirate = document.getElementById("ch2InsightPirate");
    const ch2InsightStudent = document.getElementById("ch2InsightStudent");
    const ch2Submit = document.getElementById("ch2Submit");
    const ch2Status = document.getElementById("ch2Status");

    function submitCh2() {
      const useful = ch2Useful.value;
      const emotional = ch2Emotional.value;
      const misleading = ch2Misleading.value;
      const whatIs = ch2WhatIs.value.trim();
      const conflict = ch2Conflict.value.trim();
      const insight = ch2Insight.value.trim();
      const couldBe = ch2CouldBe.value.trim();
      const iDean = ch2InsightDean.value.trim();
      const iPirate = ch2InsightPirate.value.trim();
      const iStudent = ch2InsightStudent.value.trim();

      if (!useful || !emotional || !misleading) {
        ch2Status.textContent = "Classify all three perspectives.";
        ch2Status.className = "status error";
        return;
      }

      if (whatIs.length < 10 || conflict.length < 10 || insight.length < 10 || couldBe.length < 10) {
        ch2Status.textContent = "Please complete the Story Arc sections.";
        ch2Status.className = "status error";
        return;
      }
      
      if (iDean.length < 10 || iPirate.length < 10 || iStudent.length < 10) {
          ch2Status.textContent = "Please rewrite the insight from all 3 perspectives.";
          ch2Status.className = "status error";
          return;
      }

      state.ch2Useful = useful;
      state.ch2Emotional = emotional;
      state.ch2Misleading = misleading;
      state.storyWhatIs = whatIs;
      state.storyConflict = conflict;
      state.storyInsight = insight;
      state.storyCouldBe = couldBe;
      state.insightDean = iDean;
      state.insightPirate = iPirate;
      state.insightStudent = iStudent;

      ch2Status.textContent = "Chapter 2 submitted. Unlocking Chapter 3...";
      ch2Status.className = "status success";
      setTimeout(() => goToChapter(3), 1000);
    }

    ch2Submit.addEventListener("click", submitCh2);

    // CHAPTER 3 logic
    const ch3ChartChoice = document.getElementById("ch3ChartChoice");
    const ch3Missing = document.getElementById("ch3Missing");
    const ch3Rewrite = document.getElementById("ch3Rewrite");
    const ch3Mockup = document.getElementById("ch3Mockup");
    const ch3Submit = document.getElementById("ch3Submit");
    const ch3Status = document.getElementById("ch3Status");

    function submitCh3() {
      const choice = ch3ChartChoice.value;
      const missing = ch3Missing.value.trim();
      const rewrite = ch3Rewrite.value.trim();
      const mockup = ch3Mockup.value.trim();

      if (!choice) {
        ch3Status.textContent = "Select which chart you‚Äôre correcting.";
        ch3Status.className = "status error";
        return;
      }
      if (missing.length < 10 || rewrite.length < 10 || mockup.length < 5) {
        ch3Status.textContent = "Please complete all fields, including the Honest vs Evil chart descriptions.";
        ch3Status.className = "status error";
        return;
      }

      state.ch3ChartChoice = choice;
      state.ch3Missing = missing;
      state.ch3Rewrite = rewrite;
      state.ch3Mockup = mockup;

      ch3Status.textContent = "Chapter 3 submitted. Unlocking Chapter 4...";
      ch3Status.className = "status success";
      setTimeout(() => {
          // Fill Chapter 4 anchor preview
          const anchorText = state.anchorMetricId && state.anchorMetricText
              ? `${state.anchorMetricId}: ${state.anchorMetricText}`
              : "(No anchor metric saved)";
          const ch4AnchorPreview = document.getElementById("ch4AnchorPreview");
          ch4AnchorPreview.innerHTML = `
            <strong>Anchor metric:</strong> ${anchorText}<br>
            <strong>Core Insight:</strong> ${state.storyInsight || "..."}
          `;
          goToChapter(4);
      }, 1000);
    }

    ch3Submit.addEventListener("click", submitCh3);

    // CHAPTER 4 logic
    const ch4StoryRecap = document.getElementById("ch4StoryRecap");
    const ch4Motivation = document.getElementById("ch4Motivation");
    const ch4Ability = document.getElementById("ch4Ability");
    const ch4Prompt = document.getElementById("ch4Prompt");
    const ch4Action = document.getElementById("ch4Action");
    const ch4Feedback = document.getElementById("ch4Feedback");
    const ch4RevisedAction = document.getElementById("ch4RevisedAction");
    const ch4Submit = document.getElementById("ch4Submit");
    const ch4Status = document.getElementById("ch4Status");

    function submitCh4() {
      const recap = ch4StoryRecap.value.trim();
      const mot = ch4Motivation.value.trim();
      const abil = ch4Ability.value.trim();
      const pr = ch4Prompt.value.trim();
      const act = ch4Action.value.trim();
      const fb = ch4Feedback.value.trim();
      const rev = ch4RevisedAction.value.trim();

      if (recap.length < 10 || mot.length < 10 || abil.length < 10 || pr.length < 10 || act.length < 10 || fb.length < 5 || rev.length < 10) {
        ch4Status.textContent = "Please complete all steps, including the Self-review notes.";
        ch4Status.className = "status error";
        return;
      }

      state.storyRecap = recap;
      state.actionMotivation = mot;
      state.actionAbility = abil;
      state.actionPrompt = pr;
      state.actionStatement = act;
      state.feedbackReceived = fb;
      state.revisedAction = rev;

      ch4Status.textContent = "Chapter 4 submitted. Unlocking Final Boss...";
      ch4Status.className = "status success";
      setTimeout(() => goToChapter(5), 1000);
    }

    ch4Submit.addEventListener("click", submitCh4);

    // CHAPTER 5 Logic (WITH TWIST)
    const ch5AnchorRecap = document.getElementById("ch5AnchorRecap");
    const ch5StoryArcRecap = document.getElementById("ch5StoryArcRecap");
    const ch5ChartRecap = document.getElementById("ch5ChartRecap");
    const ch5BehaviorRecap = document.getElementById("ch5BehaviorRecap");
    const ch5DeanObjection = document.getElementById("ch5DeanObjection");
    const ch5PirateObjection = document.getElementById("ch5PirateObjection");
    const ch5StudentObjection = document.getElementById("ch5StudentObjection");
    const ch5RealMetric = document.getElementById("ch5RealMetric");
    const ch5RealDraft = document.getElementById("ch5RealDraft");
    const ch5Reflection = document.getElementById("ch5Reflection");
    const ch5Status = document.getElementById("ch5Status");
    const ch5Summary = document.getElementById("ch5Summary");
    const finalOutput = document.getElementById("finalOutput");
    const copyOutputBtn = document.getElementById("copyOutput");
    const finalNameDisplay = document.getElementById("finalNameDisplay");

    // Twist variables
    let analyticsBackup = null;

    function triggerFinalBoss() {
      const anchorR = ch5AnchorRecap.value.trim();
      const storyR = ch5StoryArcRecap.value.trim();
      const chartR = ch5ChartRecap.value.trim();
      const behaveR = ch5BehaviorRecap.value.trim();
      const deanObj = ch5DeanObjection.value.trim();
      const pirateObj = ch5PirateObjection.value.trim();
      const studentObj = ch5StudentObjection.value.trim();
      const realMet = ch5RealMetric.value.trim();
      const realD = ch5RealDraft.value.trim();
      const reflect = ch5Reflection.value.trim();

      if (anchorR.length < 5 || storyR.length < 5 || chartR.length < 5 || behaveR.length < 5 || 
          deanObj.length < 5 || pirateObj.length < 5 || studentObj.length < 5 || 
          realMet.length < 5 || realD.length < 5 || reflect.length < 5) {
          ch5Status.textContent = "Please complete all fields in the Final Boss challenge.";
          ch5Status.className = "status error";
          return;
      }

      // SAVE TO STATE
      state.ch5AnchorRecap = anchorR;
      state.ch5StoryArcRecap = storyR;
      state.ch5ChartRecap = chartR;
      state.ch5BehaviorRecap = behaveR;
      state.ch5DeanObjection = deanObj;
      state.ch5PirateObjection = pirateObj;
      state.ch5StudentObjection = studentObj;
      state.ch5RealMetric = realMet;
      state.ch5RealDraft = realD;
      state.ch5Reflection = reflect;

      // WIPE UI (THE GLITCH)
      ch5AnchorRecap.value = "";
      ch5StoryArcRecap.value = "";
      ch5ChartRecap.value = "";
      ch5BehaviorRecap.value = "";
      ch5DeanObjection.value = "";
      ch5PirateObjection.value = "";
      ch5StudentObjection.value = "";
      ch5RealMetric.value = "";
      ch5RealDraft.value = "";
      ch5Reflection.value = "";

      // SHOW OVERLAY
      document.getElementById('twist-overlay').style.display = 'flex';
    }

    function restoreFromFinalBoss() {
      const answerEl = document.getElementById('finalTaskAnswer');
      const errorEl = document.getElementById('twist-error');
      const answer = (answerEl.value || '').trim();

      // Validation
      if (answer.length < 20) { // Keep it relatively easy to trigger
        errorEl.style.display = 'block';
        return;
      }
      errorEl.style.display = 'none';

      // RESTORE UI
      ch5AnchorRecap.value = state.ch5AnchorRecap;
      ch5StoryArcRecap.value = state.ch5StoryArcRecap;
      ch5ChartRecap.value = state.ch5ChartRecap;
      ch5BehaviorRecap.value = state.ch5BehaviorRecap;
      ch5DeanObjection.value = state.ch5DeanObjection;
      ch5PirateObjection.value = state.ch5PirateObjection;
      ch5StudentObjection.value = state.ch5StudentObjection;
      ch5RealMetric.value = state.ch5RealMetric;
      ch5RealDraft.value = state.ch5RealDraft;
      ch5Reflection.value = state.ch5Reflection;

      // HIDE OVERLAY
      document.getElementById('twist-overlay').style.display = 'none';

      // GENERATE FINAL REPORT
      finalNameDisplay.textContent = state.investigatorName;

      const lines = [];
      lines.push(`=== THE CURIOUS CASE OF THE VANISHING ENGAGEMENT: FINAL REPORT ===`);
      lines.push(`INVESTIGATOR: ${state.investigatorName.toUpperCase()}`);
      lines.push("");
      
      lines.push("--- PART A: THE ISLAND BLUEPRINT ---");
      lines.push(`Anchor Metric: ${state.ch5AnchorRecap}`);
      lines.push(`Story Arc: ${state.ch5StoryArcRecap}`);
      lines.push(`Chart Strategy: ${state.ch5ChartRecap}`);
      lines.push(`Recommended Behavior: ${state.ch5BehaviorRecap}`);
      lines.push("");

      lines.push("--- PART B: DEFENDING THE STRATEGY ---");
      lines.push(`Response to Dean: ${state.ch5DeanObjection}`);
      lines.push(`Response to Pirate: ${state.ch5PirateObjection}`);
      lines.push(`Response to Student: ${state.ch5StudentObjection}`);
      lines.push("");

      lines.push("--- PART C: REAL PROJECT CONNECTION ---");
      lines.push(`My Project Metric: ${state.ch5RealMetric}`);
      lines.push(`Draft Story/Action: ${state.ch5RealDraft}`);
      lines.push(`Final Reflection: ${state.ch5Reflection}`);
      lines.push("");
      
      lines.push("--- PART D: THE META REFLECTION ---");
      lines.push(`Final Principle: ${answer}`);
      lines.push("");

      lines.push("--- APPENDIX: RAW NOTES FROM ADVENTURE ---");
      lines.push(`Ch1 Defense: ${state.anchorDefense}`);
      lines.push(`Ch2 Insight (Dean): ${state.insightDean}`);
      lines.push(`Ch3 Honest vs Evil: ${state.ch3Mockup}`);
      lines.push(`Ch4 Self-Review: ${state.feedbackReceived}`);

      finalOutput.value = lines.join("\n");
      ch5Summary.style.display = "block";
      
      setTimeout(() => {
        ch5Summary.scrollIntoView({ behavior: 'smooth' });
      }, 100);

      ch5Status.textContent = "Adventure complete!";
      ch5Status.className = "status success";
    }

    copyOutputBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(finalOutput.value);
        const originalText = copyOutputBtn.innerHTML;
        copyOutputBtn.innerHTML = "Copied! ‚úÖ";
        copyOutputBtn.style.background = "#fff";
        setTimeout(() => {
             copyOutputBtn.innerHTML = originalText;
             copyOutputBtn.style.background = "#7ddc8a";
        }, 2000);
      } catch (e) {
        ch5Status.textContent = "Could not copy automatically. Please select and copy manually.";
        ch5Status.className = "status error";
      }
    });

    // Init
    renderMetrics();
    updateChapterUI();

    // Fun Layer Logic
    const COUNCIL_MESSAGES = [
      "Dean of Panic: Are you absolutely sure that metric isn‚Äôt just vibes?",
      "Marketing Pirate: Can we‚Ä¶ add more hype and less context?",
      "Student Ghost: I still don‚Äôt feel seen by this dashboard.",
      "Dean of Panic: If this fails, it‚Äôs going in the Senate report.",
      "Marketing Pirate: Have you tried calling it a 'growth story'?",
      "Student Ghost: I‚Äôm drowning in numbers, not meaning."
    ];

    const CONFUSED_MESSAGES = [
      "Confusion is the loading screen for understanding.",
      "If you feel lost, good. It means your brain is actually on.",
      "Analytics without confusion is just superficial reporting.",
      "Write the messy version first. Clarity comes second.",
      "You're not behind. The problem is genuinely weird."
    ];

    const DRAMA_MESSAGES = [
      "Dean of Panic: If this metric drops 2% we cancel the whole program.",
      "Marketing Pirate: I changed the headline without telling you. You're welcome.",
      "Student Ghost: I clicked 'agree' on your survey without reading it.",
      "Dean of Panic: Why is this number red? Red is bad. Make it green.",
      "Marketing Pirate: Can we remove the limitations slide? It ruins the mood.",
      "Student Ghost: I only saw your campaign because my friend screenshotted it."
    ];

    function showCouncilPopup(msg) {
      const popup = document.getElementById("council-popup");
      if (!popup) return;
      popup.textContent = msg;
      popup.classList.add("visible");
      setTimeout(() => popup.classList.remove("visible"), 2800);
    }

    function getEmojiState(chars) {
      if (chars < 50) return ["üòê", "Type to wake the council..."];
      if (chars < 200) return ["ü§î", "Council is listening. Keep going."];
      if (chars < 500) return ["üß†", "Your brain is officially online."];
      if (chars < 1000) return ["üî•", "Narrative engine overheating."];
      return ["üêâ", "Boss-level thinking unlocked."];
    }

    function initFunLayer() {
      const inputs = document.querySelectorAll("textarea");
      const emoji = document.getElementById("fun-emoji");
      const status = document.getElementById("fun-status-text");
      const badge = document.getElementById("chapter-badge");
      const levelupToast = document.getElementById("levelup-toast");
      if (!emoji || !status) return;

      let totalChars = 0;
      let popupCooldown = 0;
      let badgeGiven = false;

      function update() {
        totalChars = 0;
        inputs.forEach(i => totalChars += (i.value || "").length);
        const [em, text] = getEmojiState(totalChars);
        emoji.textContent = em;
        status.textContent = text;

        if (!badgeGiven && totalChars >= 400) {
          badgeGiven = true;
          badge.classList.add("unlocked");
          showCouncilPopup("üèÖ Badge unlocked: You wrote more than a LinkedIn guru.");
          
          // Trigger level-up toast
          if (levelupToast) {
              levelupToast.classList.add("visible");
              setTimeout(() => levelupToast.classList.remove("visible"), 3000);
          }
        }
      }

      inputs.forEach(field => {
        field.addEventListener("input", update);
        field.addEventListener("focus", () => {
          const now = Date.now();
          if (now - popupCooldown > 4000) {
            popupCooldown = now;
            showCouncilPopup(COUNCIL_MESSAGES[Math.floor(Math.random() * COUNCIL_MESSAGES.length)]);
          }
        });
      });

      update();
    }
    
    // Dialog System
    const DIALOG_SCENES = [
      {
        character: "Dean of Panic",
        lines: [
          "I‚Äôve seen a thousand dashboards and understood maybe five of them.",
          "If your story doesn‚Äôt survive my anxiety, it won‚Äôt survive the Senate.",
          "Start with one clear problem, not eight colorful charts."
        ]
      },
      {
        character: "Marketing Pirate",
        lines: [
          "Listen, I love a good metric, as long as it makes us look amazing.",
          "If your chart needs a paragraph of explanation, it won‚Äôt survive a campaign meeting.",
          "Give me one number to chase, and one action I can deploy tomorrow."
        ]
      },
      {
        character: "Student Ghost",
        lines: [
          "You keep saying 'engagement', but I only see posts, not people.",
          "If I don‚Äôt know what changes for me, I scroll past your story.",
          "Data that never becomes a better experience is just nicely formatted noise."
        ]
      }
    ];

    let currentDialogScene = null;
    let currentDialogIndex = 0;

    function openRandomDialog() {
      if (!DIALOG_SCENES.length) return;

      currentDialogScene = DIALOG_SCENES[Math.floor(Math.random() * DIALOG_SCENES.length)];
      currentDialogIndex = 0;

      const overlay = document.getElementById("dialog-overlay");
      const charEl = document.getElementById("dialog-character");
      const textEl = document.getElementById("dialog-text");
      if (!overlay || !charEl || !textEl) return;

      charEl.textContent = currentDialogScene.character;
      textEl.textContent = currentDialogScene.lines[currentDialogIndex] || "";
      overlay.classList.add("visible");
    }

    function advanceDialog() {
      if (!currentDialogScene) return;
      const overlay = document.getElementById("dialog-overlay");
      const textEl = document.getElementById("dialog-text");
      if (!overlay || !textEl) return;

      currentDialogIndex++;
      if (currentDialogIndex >= currentDialogScene.lines.length) {
        overlay.classList.remove("visible");
        return;
      }
      textEl.textContent = currentDialogScene.lines[currentDialogIndex];
    }

    function closeDialog() {
      const overlay = document.getElementById("dialog-overlay");
      if (overlay) {
        overlay.classList.remove("visible");
      }
      currentDialogScene = null;
      currentDialogIndex = 0;
    }

    // Wire dialog buttons
    const nextBtn = document.getElementById("dialog-next-btn");
    const closeBtn = document.getElementById("dialog-close-btn");
    if (nextBtn) nextBtn.addEventListener("click", advanceDialog);
    if (closeBtn) closeBtn.addEventListener("click", closeDialog);

    // Make these globally accessible for the onclick handlers
    window.triggerConfused = function() {
      showCouncilPopup(CONFUSED_MESSAGES[Math.floor(Math.random() * CONFUSED_MESSAGES.length)]);
    };

    window.triggerDrama = function() {
      openRandomDialog();
    };

    // --- Loading overlay logic ---
    (function initLoadingOverlay() {
      const overlay = document.getElementById("loading-overlay");
      if (!overlay) return;

      function hideOverlay() {
        overlay.style.display = "none";
      }

      // Auto-hide logic is handled by btnStartGame in the main flow, 
      // but we keep this helper just in case.
      // The main flow shows it, waits 2s, then hides it.
    })();

    // --- Level-up watcher (listens for badge unlock) ---
    (function initLevelUpWatcher() {
      const badge = document.getElementById("chapter-badge");
      const toast = document.getElementById("levelup-toast");
      if (!badge || !toast) return;

      let shown = false;

      function showToast() {
        if (shown) return;
        shown = true;
        toast.classList.add("visible");
        setTimeout(() => {
          toast.classList.remove("visible");
        }, 2600);
      }

      // Observe class changes on badge
      const observer = new MutationObserver(() => {
        if (badge.classList.contains("unlocked")) {
          showToast();
        }
      });

      observer.observe(badge, { attributes: true, attributeFilter: ["class"] });
    })();

    // Run Fun Layer Init when DOM is fully parsed
    document.addEventListener("DOMContentLoaded", initFunLayer);
    // Fallback in case DOMContentLoaded already fired
    if (document.readyState === "complete" || document.readyState === "interactive") {
        setTimeout(initFunLayer, 100);
    }

  </script>
</body>
</html>
